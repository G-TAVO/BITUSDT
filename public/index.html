<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>BITUSDT</title>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
.card{background:#111827;margin:15px;padding:15px;border-radius:12px}
input,button{width:100%;padding:10px;margin:6px;border-radius:8px;border:none}
button{background:#22c55e;color:black;font-weight:bold}
button:hover{opacity:.8}
.hide{display:none}
.admin{background:#1f2933}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginBox">
<h3>LOGIN</h3>
<input id="l_email" placeholder="Correo">
<input id="l_pass" type="password" placeholder="Contraseña">
<button onclick="login()">Entrar</button>
<p id="loginMsg"></p>
<p><small onclick="mostrarRegistro()">Crear cuenta</small></p>
</div>

<!-- REGISTRO -->
<div class="card hide" id="registerBox">
<h3>REGISTRO</h3>
<input id="r_email" placeholder="Correo">
<input id="r_pass" type="password" placeholder="Contraseña">
<button onclick="register()">Registrar</button>
<button onclick="volverLogin()">Volver</button>
<p id="msg"></p>
</div>

<!-- PANEL USUARIO -->
<div class="card hide" id="panel">
<h3>Panel Usuario</h3>

<p>Tu billetera para depositar:</p>
<p><b id="wallet"></b></p>
<button onclick="copiarWallet()">Copiar billetera</button>

<hr>

<p>Saldo: <b id="saldo">0</b> USDT</p>
<p>Día: <b id="dia">0</b>/15</p>
<p>Ganancia diaria: 1.3 USDT</p>

<input id="monto" placeholder="Monto a invertir">
<button onclick="invertir()">Invertir</button>
<button onclick="agregarWallet()">Agregar billetera</button>

<button onclick="retirar()">Retirar</button>
<button onclick="invitar()">Invitar por WhatsApp</button>
<button onclick="logout()">Salir</button>
</div>

<!-- ADMIN -->
<div class="card admin hide" id="admin">
<h3>ADMIN</h3>
<div id="lista"></div>
<button onclick="logout()">Salir</button>
</div>

<script>

// VARIABLES
let walletAdmin="TXDiTXnPUV3th3rHtZaX4XqzdJeVLbJeVo";
let usuarioActual=null;

// MOSTRAR REGISTRO
function mostrarRegistro(){
document.getElementById("loginBox").classList.add("hide");
document.getElementById("registerBox").classList.remove("hide");
}

// VOLVER LOGIN
function volverLogin(){
document.getElementById("registerBox").classList.add("hide");
document.getElementById("loginBox").classList.remove("hide");
}

// LOGIN
async function login(){

try{

const res = await fetch("/api/login",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
email: document.getElementById("l_email").value,
password: document.getElementById("l_pass").value
})
});

const data = await res.json();

if(!data.ok){
document.getElementById("loginMsg").innerText=data.msg;
return;
}

usuarioActual=data.user;
document.getElementById("loginBox").classList.add("hide");

if(data.rol==="admin"){
document.getElementById("admin").classList.remove("hide");
cargarAdmin();
}else{
document.getElementById("panel").classList.remove("hide");
cargarPanel();
}

}catch(e){
document.getElementById("loginMsg").innerText="Error servidor";
}

}

// REGISTRO
async function register(){

const email = document.getElementById("r_email").value;
const pass  = document.getElementById("r_pass").value;

if(!email || !pass){
alert("Complete todos los campos");
return;
}

try{

const res = await fetch("/api/register",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
email: email,
password: pass
})
});

const data = await res.json();
alert(data.msg);

if(data.ok){
volverLogin();
}

}catch(e){
alert("Error conectando con servidor");
}

}

// PANEL
function cargarPanel(){
document.getElementById("saldo").innerText = usuarioActual.saldo;
document.getElementById("dia").innerText = usuarioActual.dias;
document.getElementById("wallet").innerText = walletAdmin;
}

// ================== NUEVO ==================

// INVERTIR
async function invertir(){

let monto = document.getElementById("monto").value;

if(!monto){
alert("Ingrese monto");
return;
}

const res = await fetch("/api/invertir",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
email: usuarioActual.email,
monto: monto
})
});

const data = await res.json();
alert(data.msg);
}

// AGREGAR BILLETERA
async function agregarWallet(){

let w = prompt("Ingrese su billetera TRC20");

if(!w) return;

const res = await fetch("/api/wallet",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
email: usuarioActual.email,
wallet: w
})
});

const data = await res.json();
alert(data.msg);
}

// RETIRAR
async function retirar(){

const res = await fetch("/api/retirar",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
email: usuarioActual.email
})
});

const data = await res.json();
alert(data.msg);
}

// ADMIN
async function cargarAdmin(){

const res = await fetch("/api/solicitudes");
const data = await res.json();

let html="";

data.forEach(s=>{

html+=`
<div class="card">
<b>${s.email}</b><br>
Monto: ${s.monto}<br>
Tipo: ${s.tipo}<br>
${s.wallet ? "Wallet: "+s.wallet+"<br>" : ""}
<button onclick="aprobar(${s.id})">Aprobar</button>
<button onclick="rechazar(${s.id})">Rechazar</button>
</div>
`;

});

document.getElementById("lista").innerHTML=html;
}

// APROBAR
async function aprobar(id){

await fetch("/api/aprobar",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({id})
});

alert("Aprobado");
cargarAdmin();
}

// RECHAZAR
async function rechazar(id){

await fetch("/api/rechazar",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({id})
});

alert("Rechazado");
cargarAdmin();
}

// ================== FIN ==================

// INVITAR
function invitar(){
window.open("https://wa.me/?text=Regístrate aquí https://bitusdt-1.onrender.com");
}

// COPIAR
function copiarWallet(){
navigator.clipboard.writeText(walletAdmin);
alert("Billetera copiada");
}

// LOGOUT
function logout(){
location.reload();
}

</script>
</body>
</html>
